<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src * data:; connect-src 'self'; base-uri 'none'; form-action 'none';"><title>Siphon — Browser Feed Reader</title><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet"><style>:root{--bg:#0e0f11;--surface:#16171b;--surface-hover:#1c1d22;--border:#2a2b31;--border-light:#35363d;--text:#e4e4e7;--text-dim:#8a8b96;--text-faint:#55565f;--accent:#c8a46e;--accent-dim:#a08450;--accent-glow:rgba(200, 164, 110, 0.08);--danger:#c0564a;--new-color:#5a9e6f;--new-bg:rgba(90, 158, 111, 0.08);--radius:8px;--font-display:"DM Serif Display",Georgia,serif;--font-body:"IBM Plex Sans",-apple-system,sans-serif;--font-mono:"IBM Plex Mono",monospace}*{margin:0;padding:0;box-sizing:border-box}body,html{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:15px;line-height:1.6;-webkit-font-smoothing:antialiased}.app{height:100vh;display:flex;flex-direction:column;overflow:hidden}.topbar{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;min-height:50px}.topbar-logo{font-family:var(--font-display);font-size:18px;color:var(--accent);display:flex;align-items:center;gap:8px;flex-shrink:0}.topbar-logo svg{flex-shrink:0}.topbar-breadcrumb{font-family:var(--font-mono);font-size:11px;color:var(--text-faint);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.topbar-breadcrumb .crumb-link{color:var(--text-dim);cursor:pointer;transition:color .15s}.topbar-breadcrumb .crumb-link:hover{color:var(--accent)}.topbar-breadcrumb .sep{margin:0 6px;color:var(--text-faint)}.topbar-right{display:flex;align-items:center;gap:8px;flex-shrink:0}.auto-label{font-family:var(--font-mono);font-size:10px;color:var(--text-faint)}.panels{flex:1;overflow:hidden;position:relative}.panel{position:absolute;inset:0;display:flex;flex-direction:column;overflow:hidden;background:var(--bg);transition:transform .25s ease,opacity .2s ease}.panel.hidden{pointer-events:none;opacity:0;transform:translateX(-30px)}.panel.hidden-right{pointer-events:none;opacity:0;transform:translateX(30px)}.btn{background:var(--accent);color:var(--bg);border:none;border-radius:var(--radius);font-family:var(--font-body);font-weight:600;font-size:13px;padding:10px 16px;cursor:pointer;transition:background .2s,transform .1s;white-space:nowrap;flex-shrink:0}.btn:hover{background:var(--accent-dim)}.btn:active{transform:scale(.97)}.btn:disabled{opacity:.5;cursor:wait}.btn-small{padding:6px 12px;font-size:12px;border-radius:6px}.btn-ghost{background:0 0;color:var(--text-dim);border:1px solid var(--border)}.btn-ghost:hover{background:var(--surface-hover);color:var(--text)}.btn-icon{background:0 0;border:none;color:var(--text-dim);cursor:pointer;padding:6px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s;flex-shrink:0}.btn-icon:hover{background:var(--surface-hover);color:var(--text)}.btn-icon.spinning svg{animation:spin .8s linear infinite}.feeds-panel{z-index:3}.add-feed{padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}.add-feed-row{display:flex;gap:6px}.add-feed input{flex:1;min-width:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font-mono);font-size:13px;padding:10px 12px;outline:0;transition:border-color .2s}.add-feed input::placeholder{color:var(--text-faint)}.add-feed input:focus{border-color:var(--accent-dim)}.add-error{font-size:11px;color:var(--danger);margin-top:6px;font-family:var(--font-mono)}.feed-list{flex:1;overflow-y:auto;padding:6px 0}.feed-list::-webkit-scrollbar{width:4px}.feed-list::-webkit-scrollbar-track{background:0 0}.feed-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}.feed-section-label{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:var(--text-faint);padding:12px 16px 6px}.feed-item{display:flex;align-items:center;gap:8px;padding:8px 16px;cursor:pointer;transition:background .12s,opacity .2s;position:relative}.feed-item:hover{background:var(--surface-hover)}.feed-item.active{background:var(--accent-glow);border-left:2px solid var(--accent);padding-left:14px}.feed-item.dragging{opacity:.4}.feed-item.drag-over-top{box-shadow:0 -2px 0 var(--accent) inset}.feed-item.drag-over-bottom{box-shadow:0 2px 0 var(--accent) inset}.feed-icon-wrap{position:relative;flex-shrink:0}.feed-fav-star{position:absolute;bottom:-2px;right:-3px;color:var(--accent);font-size:10px;line-height:1;filter:drop-shadow(0 0 2px var(--bg));display:none}.feed-fav-star.is-fav{display:block}.feed-icon-circle{width:28px;height:28px;border-radius:6px;background:var(--surface);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;font-weight:600;color:var(--text-dim);overflow:hidden}.feed-icon-circle img{width:100%;height:100%;object-fit:cover}.feed-info{flex:1;min-width:0}.feed-name{font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.feed-url-hint{font-family:var(--font-mono);font-size:10px;color:var(--text-faint);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.feed-right{display:flex;align-items:center;gap:4px;flex-shrink:0}.feed-count{font-family:var(--font-mono);font-size:10px;color:var(--accent-dim);background:var(--accent-glow);padding:2px 7px;border-radius:10px;flex-shrink:0}.feed-actions{position:relative;flex-shrink:0}.feed-dots{background:0 0;border:none;color:var(--text-faint);cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background .15s,color .15s;opacity:0;transition:opacity .15s}.feed-item:hover .feed-dots{opacity:1}.feed-dots:hover{background:var(--surface-hover);color:var(--text)}.feed-menu{display:none;position:absolute;right:0;top:100%;margin-top:4px;background:var(--surface);border:1px solid var(--border);border-radius:8px;min-width:150px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.4);overflow:hidden}.feed-menu.open{display:block}.feed-menu-item{display:flex;align-items:center;gap:8px;padding:9px 14px;font-family:var(--font-body);font-size:13px;color:var(--text-dim);cursor:pointer;transition:background .12s,color .12s;border:none;background:0 0;width:100%;text-align:left}.feed-menu-item:hover{background:var(--surface-hover);color:var(--text)}.feed-menu-item.danger{color:var(--danger)}.feed-menu-item.danger:hover{background:rgba(192,86,74,.08)}.feed-menu-item svg{flex-shrink:0}.feeds-footer{padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0;display:flex;gap:6px;flex-wrap:wrap}.cors-note{font-size:10px;color:var(--text-faint);padding:8px 16px;line-height:1.5;border-top:1px solid var(--border);flex-shrink:0}.sync-section{padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0}.sync-row{display:flex;align-items:center;gap:6px}.sync-input{font-family:var(--font-mono);font-size:11px;background:var(--surface);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;padding:4px 8px;flex:1;min-width:0}.sync-input:focus{outline:0;border-color:var(--accent);color:var(--text)}.sync-status{font-family:var(--font-mono);font-size:10px;color:var(--text-faint);margin-top:4px}.list-panel{z-index:2}.list-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;background:var(--surface)}.list-header-title{font-family:var(--font-display);font-size:18px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.list-header-count{font-family:var(--font-mono);font-size:11px;color:var(--text-faint);flex-shrink:0}.toggle-row{display:flex;align-items:center;gap:8px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}.toggle-label{font-family:var(--font-mono);font-size:11px;color:var(--text-dim);flex:1;cursor:pointer;user-select:none}.toggle-switch{width:34px;height:18px;border-radius:9px;background:var(--border);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}.toggle-switch.on{background:var(--accent-dim)}.toggle-switch::after{content:"";position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--text);transition:transform .2s}.toggle-switch.on::after{transform:translateX(16px)}.unread-count-badge{font-family:var(--font-mono);font-size:10px;color:var(--accent);background:var(--accent-glow);padding:1px 6px;border-radius:8px}.article-list{flex:1;overflow-y:auto}.article-list::-webkit-scrollbar{width:5px}.article-list::-webkit-scrollbar-track{background:0 0}.article-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}.article-row{padding:14px 16px;padding-right:40px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s,opacity .15s;height:95px;overflow:hidden;position:relative}.article-row:hover{background:var(--surface)}.article-row.active{background:var(--accent-glow);border-left:2px solid var(--accent);padding-left:14px}.article-row.is-read{opacity:.45}.article-row.is-read:hover{opacity:.7}.article-row.is-read .article-row-title{color:var(--text-dim)}.article-row.is-new{border-left:2px solid var(--new-color);padding-left:14px}.article-row.is-new.active{border-left-color:var(--accent)}.article-row-top{display:flex;align-items:baseline;gap:8px}.article-row-title{font-family:var(--font-display);font-size:16px;color:var(--text);line-height:1.35;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}.new-badge{font-family:var(--font-mono);font-size:9px;text-transform:uppercase;letter-spacing:.05em;color:var(--new-color);background:var(--new-bg);padding:1px 6px;border-radius:4px;flex-shrink:0;font-weight:600}.article-row-meta{font-family:var(--font-mono);font-size:11px;color:var(--text-faint);display:flex;gap:8px;flex-wrap:wrap}.article-row-meta .source{color:var(--accent-dim)}.article-row-snippet{font-size:13px;color:var(--text-dim);margin-top:6px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.row-read-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:0 0;border:none;cursor:pointer;padding:4px;color:var(--text-faint);opacity:0;transition:opacity .15s,color .15s;display:flex;align-items:center;justify-content:center}.article-row:hover .row-read-btn{opacity:1}.row-read-btn:hover{color:var(--accent)}.date-section{height:34px;display:flex;align-items:center;padding:0 16px;position:absolute;left:0;right:0;pointer-events:none}.date-section-label{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--accent-dim);background:var(--bg);padding:0 8px 0 0;position:relative;z-index:1}.date-section-line{flex:1;height:1px;background:var(--border)}.reader-panel{z-index:1}.reader-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;background:var(--surface)}.reader-scroll{flex:1;overflow-y:auto;padding:24px 20px 60px}.reader-scroll::-webkit-scrollbar{width:5px}.reader-scroll::-webkit-scrollbar-track{background:0 0}.reader-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}.reader-title{font-family:var(--font-display);font-size:26px;line-height:1.3;color:var(--text);margin-bottom:10px}.reader-meta{font-family:var(--font-mono);font-size:11px;color:var(--text-faint);margin-bottom:6px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}.reader-meta .source{color:var(--accent-dim)}.reader-read-toggle{font-family:var(--font-mono);font-size:10px;color:var(--text-dim);background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:2px 8px;cursor:pointer;transition:color .15s,border-color .15s}.reader-read-toggle:hover{color:var(--accent);border-color:var(--accent-dim)}.reader-link{display:inline-flex;align-items:center;gap:5px;font-family:var(--font-mono);font-size:12px;color:var(--accent);text-decoration:none;margin-bottom:20px;transition:color .15s}.reader-link:hover{color:var(--accent-dim);text-decoration:underline}.reader-content{font-size:15px;color:var(--text-dim);line-height:1.75}.reader-content a{color:var(--accent);text-decoration:none}.reader-content a:hover{text-decoration:underline}.reader-content img{max-width:100%;border-radius:var(--radius);margin:12px 0}.reader-content p{margin-bottom:12px}.reader-content h1,.reader-content h2,.reader-content h3{color:var(--text);margin:20px 0 8px;font-family:var(--font-display)}.reader-content code,.reader-content pre{font-family:var(--font-mono);font-size:13px;background:var(--surface);padding:2px 5px;border-radius:4px}.reader-content pre{padding:12px;overflow-x:auto;margin:12px 0}.reader-content blockquote{border-left:3px solid var(--accent-dim);padding-left:16px;margin:12px 0;color:var(--text-dim);font-style:italic}.reader-nav{display:flex;gap:8px;margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}.state-message{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px 20px;text-align:center}.state-icon{width:52px;height:52px;border-radius:14px;background:var(--surface);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;margin-bottom:14px}.state-title{font-family:var(--font-display);font-size:18px;color:var(--text);margin-bottom:6px}.state-desc{font-size:13px;color:var(--text-dim);max-width:320px;line-height:1.6}.state-desc code{font-family:var(--font-mono);font-size:11px;background:var(--surface);padding:2px 6px;border-radius:4px;border:1px solid var(--border);cursor:pointer}.state-desc code:hover{border-color:var(--accent-dim)}.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{font-family:var(--font-mono);font-size:11px;color:var(--text-faint)}@media (min-width:900px){.panels{display:grid;grid-template-columns:260px 1fr}.panel{position:relative;transform:none!important;opacity:1!important;pointer-events:auto!important}.feeds-panel{border-right:1px solid var(--border)}.list-panel{display:none}.reader-panel{display:flex}.panels.wide-has-reader{grid-template-columns:260px 340px 1fr}.panels.wide-has-reader .list-panel{display:flex;border-right:1px solid var(--border)}.panels.wide-has-reader .reader-panel{display:flex}.panels.wide-no-reader{grid-template-columns:260px 1fr}.panels.wide-no-reader .list-panel{display:flex}.panels.wide-no-reader .reader-panel{display:none}.list-header .btn-icon.back-btn,.reader-header .btn-icon.back-btn{display:none}}@media (max-width:899px){.panel{position:absolute}}</style></head><body><div class="app"><div class="topbar"><div class="topbar-logo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1.5" fill="currentColor"/></svg> Siphon</div><div class="topbar-breadcrumb" id="breadcrumb"></div><div class="topbar-right"><div class="auto-label" id="nextRefreshLabel"></div><div id="globalLoading" style="display:none;align-items:center;gap:8px"></div></div></div><div class="panels" id="panels"><div class="panel feeds-panel" id="feedsPanel"><div class="add-feed"><div class="add-feed-row"><input type="text" id="feedUrl" placeholder="Paste feed URL…" spellcheck="false" autocomplete="off"><button class="btn" id="addBtn" onclick="addFeed()">Add</button></div><div class="add-error" id="addError"></div></div><div class="feed-list" id="feedList"></div><div class="feeds-footer"><button class="btn btn-small btn-ghost" onclick="refreshAll(!0)">↻ Refresh all</button><button class="btn btn-small btn-ghost" onclick="exportOpml()">Export</button><button class="btn btn-small btn-ghost" onclick='document.getElementById("opmlImport").click()'>Import</button><input type="file" id="opmlImport" accept=".opml,.xml,.txt" style="display:none" onchange="importOpml(event)"></div><div class="sync-section"><div class="sync-row"><input type="password" class="sync-input" id="syncPhrase" placeholder="Sync passphrase…" spellcheck="false" autocomplete="off"><button class="btn btn-small btn-ghost" id="syncBtn" onclick="syncNow()">Sync</button></div><div class="sync-status" id="syncStatus"></div></div><div class="cors-note">Feeds are fetched via the built-in proxy.</div></div><div class="panel list-panel hidden-right" id="listPanel"><div class="list-header"><button class="btn-icon back-btn" onclick="history.back()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button><div class="list-header-title" id="listTitle">All Articles</div><div class="list-header-count" id="listCount"></div></div><div class="toggle-row"><label class="toggle-label" onclick="toggleHideRead()">Hide read</label><span class="unread-count-badge" id="unreadBadge"></span><div class="toggle-switch" id="hideReadToggle" onclick="toggleHideRead()"></div><div style="flex:1"></div><button class="btn btn-small btn-ghost" onclick="markAllRead()">Mark all read</button></div><div class="article-list" id="articleList"></div></div><div class="panel reader-panel hidden-right" id="readerPanel"><div class="reader-header"><button class="btn-icon back-btn" onclick="history.back()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button><span class="loading-text" id="readerHeaderLabel" style="flex:1">Reading</span><button class="btn-icon" onclick="history.back()" title="Close article"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="reader-scroll" id="readerScroll"><div class="state-message"><div class="state-title">Select an article</div><div class="state-desc">Pick something from the list to read it here.</div></div></div></div></div></div><script>let feeds=[],articles=[],activeFeedUrl=null,activeArticleIdx=-1,currentView="feeds",isLoading=!1,hideRead=!1,readSet=new Set,newSet=new Set,knownSet=new Set;const CACHE_MAX_AGE=6e5,AUTO_REFRESH_MS=3e5;let autoTimer=null,countdownTimer=null,nextRefreshAt=0;try{feeds=JSON.parse(localStorage.getItem("siphon_feeds")||"[]")}catch{feeds=[]}try{readSet=new Set(JSON.parse(localStorage.getItem("siphon_read")||"[]"))}catch{}try{hideRead=JSON.parse(localStorage.getItem("siphon_hideread")||"false")}catch{}try{knownSet=new Set(JSON.parse(localStorage.getItem("siphon_known")||"[]"))}catch{}let localTs=0;try{localTs=JSON.parse(localStorage.getItem("siphon_ts")||"0")}catch{}let feedFetchTs={};try{feedFetchTs=JSON.parse(localStorage.getItem("siphon_fetch_ts")||"{}")}catch{}function saveFetchTs(){try{localStorage.setItem("siphon_fetch_ts",JSON.stringify(feedFetchTs))}catch{}}function saveTs(){localTs=Date.now(),localStorage.setItem("siphon_ts",JSON.stringify(localTs))}function articleKey(e){return e.link||e.title+"||"+e.feedUrl}function isRead(e){return readSet.has(articleKey(e))}function isNew(e){return newSet.has(articleKey(e))}function markRead(e){const t=articleKey(e);readSet.has(t)||(readSet.add(t),newSet.delete(t),saveRead(),deferSync())}function markUnread(e){readSet.delete(articleKey(e)),saveRead(),deferSync()}function saveRead(){const e=[...readSet];e.length>5e3&&(readSet=new Set(e.slice(-5e3))),localStorage.setItem("siphon_read",JSON.stringify([...readSet]))}function saveKnown(){const e=[...knownSet];e.length>1e4&&(knownSet=new Set(e.slice(-1e4))),localStorage.setItem("siphon_known",JSON.stringify([...knownSet]))}function saveFeeds(){localStorage.setItem("siphon_feeds",JSON.stringify(feeds))}function toggleHideRead(){hideRead=!hideRead,localStorage.setItem("siphon_hideread",JSON.stringify(hideRead)),document.getElementById("hideReadToggle").classList.toggle("on",hideRead),exemptKey=null,cFiltered=null,renderArticleList(),deferSync()}function markAllRead(){(activeFeedUrl?articles.filter(e=>e.feedUrl===activeFeedUrl):articles).forEach(e=>{markRead(e)}),exemptKey=null,cFiltered=null,renderArticleList(),renderFeedList()}function markAllReadFeed(e,t){t&&t.stopPropagation(),openMenuId=null,articles.filter(t=>t.feedUrl===e).forEach(e=>{markRead(e)}),cFiltered=null,renderArticleList(),renderFeedList()}function toggleReadRow(e,t){t.stopPropagation();const n=getFiltered();if(e<0||e>=n.length)return;const r=n[e];isRead(r)?markUnread(r):markRead(r),cFiltered=null,lastRange=null,renderVisibleRows(),renderFeedList()}function toggleReadInReader(){const e=getFiltered();if(activeArticleIdx<0||activeArticleIdx>=e.length)return;const t=e[activeArticleIdx];isRead(t)?(markUnread(t),exemptKey=null):(markRead(t),exemptKey=articleKey(t)),cFiltered=null,renderOpenArticle(),lastRange=null,renderVisibleRows(),renderFeedList()}let cacheDB=null;function openCacheDB(){return new Promise((e,t)=>{const n=indexedDB.open("siphon_cache",1);n.onupgradeneeded=e=>{e.target.result.createObjectStore("feeds")},n.onsuccess=t=>{cacheDB=t.target.result,e(cacheDB)},n.onerror=e=>t(e.target.error)})}async function migrateCache(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&n.startsWith("siphon_c_")&&e.push(n)}if(!e.length)return;const t=cacheDB.transaction("feeds","readwrite"),n=t.objectStore("feeds");e.forEach(e=>{try{const t=JSON.parse(localStorage.getItem(e));n.put(t,e.slice(9)),localStorage.removeItem(e)}catch{localStorage.removeItem(e)}}),await new Promise(e=>{t.oncomplete=e,t.onerror=e})}async function getCache(e){try{if(!cacheDB)return null;const t=await new Promise(t=>{const n=cacheDB.transaction("feeds","readonly").objectStore("feeds").get(e);n.onsuccess=()=>t(n.result||null),n.onerror=()=>t(null)});return t&&Date.now()-t.ts<=6e5?t:null}catch{return null}}async function setCache(e,t,n,r,i){try{if(!cacheDB)return;await new Promise(s=>{const a=cacheDB.transaction("feeds","readwrite");a.objectStore("feeds").put({ts:Date.now(),t:t,ic:n,items:r,np:i||null},e),a.oncomplete=()=>s(),a.onerror=()=>s()})}catch{}}async function delCache(e){try{if(!cacheDB)return;cacheDB.transaction("feeds","readwrite").objectStore("feeds").delete(e)}catch{}}async function getStaleCache(e){try{return cacheDB?new Promise(t=>{const n=cacheDB.transaction("feeds","readonly").objectStore("feeds").get(e);n.onsuccess=()=>t(n.result||null),n.onerror=()=>t(null)}):null}catch{return null}}async function loadFromCache(){articles=[],await Promise.all(feeds.map(async e=>{const t=await getStaleCache(e.url);t&&(e.title=t.t||e.title,e.icon=t.ic||e.icon,e.nextPageUrl=t.np||null,integrateItems(e.url,t.items,!0))}))}const IS_LOCAL="file:"===location.protocol,PROXIES=IS_LOCAL?[e=>e]:[e=>"/proxy?url="+encodeURIComponent(e)];function isWide(){return innerWidth>=900}async function fetchCors(e){for(const t of PROXIES)try{const n=await fetch(t(e),{signal:AbortSignal.timeout(15e3)});if(n.ok){const e=await n.text();if(e.includes("<")&&(e.includes("<rss")||e.includes("<feed")||e.includes("<channel")))return e}}catch{}throw new Error("CORS blocked or network error")}function parseFeed(e,t){const n=(new DOMParser).parseFromString(e,"text/xml");if(n.querySelector("parsererror"))throw new Error("Invalid XML");const r=[];let i="",s="",a=null;const l=n.querySelector("channel");l&&(i=l.querySelector(":scope>title")?.textContent?.trim()||t,s=l.querySelector(":scope>image>url")?.textContent?.trim()||"",l.querySelectorAll("item").forEach(e=>{r.push({title:e.querySelector("title")?.textContent?.trim()||"Untitled",link:e.querySelector("link")?.textContent?.trim()||"",description:e.querySelector("description")?.textContent?.trim()||"",content:e.querySelector("content\\:encoded,encoded")?.textContent?.trim()||e.querySelector("description")?.textContent?.trim()||"",pubDate:e.querySelector("pubDate")?.textContent?.trim()||e.querySelector("date")?.textContent?.trim()||"",author:e.querySelector("author")?.textContent?.trim()||e.querySelector("dc\\:creator,creator")?.textContent?.trim()||"",feedUrl:t,feedTitle:i})}),l.querySelectorAll("link").forEach(e=>{if("next"===e.getAttribute("rel")&&e.getAttribute("href"))try{a=new URL(e.getAttribute("href"),t).href}catch{}}));const o=n.querySelector("feed");if(!l&&o){i=o.querySelector(":scope>title")?.textContent?.trim()||t,s=o.querySelector(":scope>icon")?.textContent?.trim()||"",o.querySelectorAll("entry").forEach(e=>{const n=e.querySelector('link[rel="alternate"],link:not([rel])');r.push({title:e.querySelector("title")?.textContent?.trim()||"Untitled",link:n?.getAttribute("href")||"",description:e.querySelector("summary")?.textContent?.trim()||"",content:e.querySelector("content")?.textContent?.trim()||e.querySelector("summary")?.textContent?.trim()||"",pubDate:e.querySelector("published,updated")?.textContent?.trim()||"",author:e.querySelector("author>name")?.textContent?.trim()||"",feedUrl:t,feedTitle:i})});const e=o.querySelector(':scope>link[rel="next"]');if(e&&e.getAttribute("href"))try{a=new URL(e.getAttribute("href"),t).href}catch{}}if(!l&&!o)throw new Error("Not a valid RSS/Atom feed");return{feedTitle:i,feedIcon:s,items:r,nextPageUrl:a}}function stripHtml(e){return e?e.replace(/<br\s*\/?>/gi," ").replace(/<\/p>/gi," ").replace(/<[^>]*>/g,"").replace(/&nbsp;/gi," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/").replace(/\s+/g," ").trim():""}function fmtDate(e){if(!e)return"";try{const t=new Date(e);if(isNaN(t))return e;const n=new Date,r=n-t;return r<36e5?Math.floor(r/6e4)+"m ago":r<864e5?Math.floor(r/36e5)+"h ago":r<6048e5?Math.floor(r/864e5)+"d ago":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==n.getFullYear()?"numeric":void 0})}catch{return e}}function sortT(e){try{return new Date(e).getTime()||0}catch{return 0}}function esc(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function escX(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function sanitize(e){if(!e)return"";const t=new Set(["p","div","span","a","img","br","hr","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","h5","h6","em","strong","b","i","u","s","sub","sup","table","thead","tbody","tr","td","th","figure","figcaption","picture","source","dl","dt","dd","details","summary"]),n=new Set(["script","style","iframe","object","embed","form","svg","math","base","meta","link","template","noscript","textarea","select","input","button"]),r={a:new Set(["href"]),img:new Set(["src","alt","width","height"]),td:new Set(["colspan","rowspan"]),th:new Set(["colspan","rowspan"]),source:new Set(["srcset","media","type"])},i=/^\s*(javascript|data|vbscript|blob)\s*:/i,s=document.createElement("div");return s.innerHTML=e,function e(s){const a=Array.from(s.childNodes);for(const l of a){if(l.nodeType===Node.COMMENT_NODE){s.removeChild(l);continue}if(l.nodeType===Node.TEXT_NODE)continue;if(l.nodeType!==Node.ELEMENT_NODE){s.removeChild(l);continue}const a=l.tagName.toLowerCase();if(n.has(a)){s.removeChild(l);continue}if(!t.has(a)){for(e(l);l.firstChild;)s.insertBefore(l.firstChild,l);s.removeChild(l);continue}const o=r[a]||new Set;for(const e of Array.from(l.attributes)){const t=e.name.toLowerCase();!t.startsWith("on")&&o.has(t)||l.removeAttribute(e.name)}if("a"===a){const e=l.getAttribute("href");e&&i.test(e)&&l.removeAttribute("href"),l.setAttribute("target","_blank"),l.setAttribute("rel","noopener noreferrer")}if("img"===a){const e=l.getAttribute("src");if(e&&i.test(e)&&l.removeAttribute("src"),l.setAttribute("referrerpolicy","no-referrer"),!IS_LOCAL){const e=l.getAttribute("src");e&&e.startsWith("http")&&(l.dataset.original=e,l.setAttribute("onerror",'if(!this.dataset.proxied){this.dataset.proxied=1;this.src="/proxy?url="+encodeURIComponent(this.dataset.original)}'))}}if("source"===a){const e=l.getAttribute("srcset");e&&i.test(e)&&l.removeAttribute("srcset")}e(l)}}(s),s.innerHTML}function setLoading(e){isLoading=e,document.getElementById("globalLoading").style.display=e?"flex":"none"}function hostOf(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return e}}let cFiltered=null,cFilterKey=null,exemptKey=null;function getFiltered(){const e=(activeFeedUrl||"__all__")+":"+articles.length+":"+hideRead+":"+readSet.size+":"+(exemptKey||"");if(cFilterKey===e&&cFiltered)return cFiltered;let t=activeFeedUrl?articles.filter(e=>e.feedUrl===activeFeedUrl):articles.slice();if(hideRead){const e=exemptKey;t=t.filter(t=>!isRead(t)||articleKey(t)===e)}return t.sort((e,t)=>sortT(t.pubDate)-sortT(e.pubDate)),cFiltered=t,cFilterKey=e,t}let _navPush=!1;function navigate(e){const t=currentView;currentView=e,_navPush&&t!==e&&history.pushState({view:e},"");const n=document.getElementById("feedsPanel"),r=document.getElementById("listPanel"),i=document.getElementById("readerPanel"),s=document.getElementById("panels");isWide()?(n.classList.remove("hidden","hidden-right"),activeArticleIdx>=0?(s.className="panels wide-has-reader",r.classList.remove("hidden","hidden-right"),i.classList.remove("hidden","hidden-right")):(s.className="panels wide-no-reader",r.classList.remove("hidden","hidden-right"),i.classList.add("hidden-right"))):(s.className="panels",n.classList.toggle("hidden","feeds"!==e),n.classList.remove("hidden-right"),r.classList.toggle("hidden","feeds"===e),r.classList.toggle("hidden-right","reader"===e),i.classList.toggle("hidden-right","reader"!==e),i.classList.toggle("hidden",!1),"reader"!==e&&i.classList.add("hidden-right")),updBreadcrumb()}function showFeeds(){navigate("feeds")}function showList(){activeArticleIdx=-1,exemptKey=null,cFiltered=null,sessionStorage.setItem("siphon_view",JSON.stringify({feed:activeFeedUrl,article:null})),navigate("list"),renderArticleList()}function closeReader(){activeArticleIdx=-1,exemptKey=null,cFiltered=null,sessionStorage.setItem("siphon_view",JSON.stringify({feed:activeFeedUrl,article:null})),renderArticleList(),navigate("list")}function updBreadcrumb(){const e=document.getElementById("breadcrumb");let t=[];if(isWide()||"feeds"===currentView)t=[];else if("list"===currentView){t.push('<span class="crumb-link" onclick="showFeeds()">Feeds</span>');const e=activeFeedUrl?feeds.find(e=>e.url===activeFeedUrl)?.title||"Feed":"All";t.push("<span>"+esc(e)+"</span>")}else if("reader"===currentView){t.push('<span class="crumb-link" onclick="showFeeds()">Feeds</span>');const e=activeFeedUrl?feeds.find(e=>e.url===activeFeedUrl)?.title||"Feed":"All";t.push('<span class="crumb-link" onclick="showList()">'+esc(e)+"</span>"),t.push("<span>Article</span>")}e.innerHTML=t.join('<span class="sep">›</span>')}async function addFeed(){const e=document.getElementById("feedUrl"),t=document.getElementById("addError"),n=document.getElementById("addBtn");let r=e.value.trim();if(r)if(r.match(/^https?:\/\//)||(r="https://"+r),feeds.find(e=>e.url===r))t.textContent="Already added.";else{t.textContent="",e.disabled=!0,n.disabled=!0,n.textContent="…",setLoading(!0);try{const t=await fetchCors(r),{feedTitle:n,feedIcon:i,items:s,nextPageUrl:a}=parseFeed(t,r);feeds.push({url:r,title:n,icon:i,nextPageUrl:a||null}),saveFeeds(),await setCache(r,n,i,s,a),s.forEach(e=>knownSet.add(articleKey(e))),saveKnown(),articles=articles.concat(s),cFiltered=null,e.value="",renderFeedList(),selectFeed(r),deferSync()}catch(e){t.textContent=e.message||"Failed."}finally{e.disabled=!1,n.disabled=!1,n.textContent="Add",setLoading(!1),e.focus()}}}function selectFeed(e){activeFeedUrl=e,activeArticleIdx=-1,exemptKey=null,cFiltered=null,sessionStorage.setItem("siphon_view",JSON.stringify({feed:e,article:null})),renderFeedList(),renderArticleList(),navigate("list")}function removeFeed(e,t){t.stopPropagation(),openMenuId=null,feeds=feeds.filter(t=>t.url!==e),saveFeeds(),delCache(e),delete feedFetchTs[e],saveFetchTs(),articles=articles.filter(t=>t.feedUrl!==e),activeFeedUrl===e&&(activeFeedUrl=null),activeArticleIdx=-1,cFiltered=null,renderFeedList(),renderArticleList(),deferSync()}document.getElementById("feedUrl").addEventListener("keydown",e=>{"Enter"===e.key&&addFeed()});let refreshGen=0,renderTimer=null;function integrateItems(e,t,n){articles=articles.filter(t=>t.feedUrl!==e),n||t.forEach(e=>{const t=articleKey(e);knownSet.has(t)||newSet.add(t)}),t.forEach(e=>knownSet.add(articleKey(e))),articles=articles.concat(t)}async function refreshOneFeed(e,t){const n=feeds.find(t=>t.url===e);if(!n)return"skip";if(!t){const t=await getCache(e);if(t)return n.title=t.t||n.title,n.icon=t.ic||n.icon,n.nextPageUrl=t.np||null,integrateItems(e,t.items,!0),"cached"}try{const r=parseFeed(await fetchCors(e),e);return n.title=r.feedTitle||n.title,n.icon=r.feedIcon||n.icon,n.nextPageUrl=r.nextPageUrl||null,await setCache(e,r.feedTitle,r.feedIcon,r.items,r.nextPageUrl),feedFetchTs[e]=Date.now(),saveFetchTs(),integrateItems(e,r.items,!t),"fetched"}catch{feedFetchTs[e]=Date.now(),saveFetchTs();const t=await getStaleCache(e);return t?(n.title=t.t||n.title,n.icon=t.ic||n.icon,n.nextPageUrl=t.np||null,integrateItems(e,t.items,!0),"stale"):"failed"}}async function refreshAll(e){const t=++refreshGen;setLoading(!0);let n=0;const r=feeds.length;updStatus(0,r);const i=feeds.map(async i=>{await refreshOneFeed(i.url,!!e),t===refreshGen&&(n++,updStatus(n,r),renderTimer||(renderTimer=setTimeout(()=>{renderTimer=null,t===refreshGen&&(cFiltered=null,renderFeedList(),renderArticleList())},200)))});await Promise.allSettled(i),t===refreshGen&&(renderTimer&&(clearTimeout(renderTimer),renderTimer=null),saveFeeds(),saveKnown(),saveTs(),cFiltered=null,renderFeedList(),renderArticleList(),setLoading(!1),updStatus(-1,0),scheduleAuto())}async function refreshStale(){const e=feeds.filter(e=>Date.now()-(feedFetchTs[e.url]||0)>6e5);if(0===e.length)return void scheduleAuto();const t=++refreshGen;setLoading(!0);let n=0;const r=e.length;updStatus(0,r);const i=e.map(async e=>{await refreshOneFeed(e.url,!0),t===refreshGen&&(n++,updStatus(n,r),renderTimer||(renderTimer=setTimeout(()=>{renderTimer=null,t===refreshGen&&(cFiltered=null,renderFeedList(),renderArticleList())},200)))});await Promise.allSettled(i),t===refreshGen&&(renderTimer&&(clearTimeout(renderTimer),renderTimer=null),saveFeeds(),saveKnown(),saveTs(),cFiltered=null,renderFeedList(),renderArticleList(),setLoading(!1),updStatus(-1,0),scheduleAuto())}async function refreshSingleFeed(e,t){t&&t.stopPropagation(),openMenuId=null;const n="rf_"+e.replace(/\W/g,"_"),r=document.getElementById(n);r&&r.classList.add("spinning"),await refreshOneFeed(e,!0),saveFeeds(),saveKnown(),cFiltered=null,renderFeedList(),renderArticleList(),r&&r.classList.remove("spinning")}function updStatus(e,t){const n=document.getElementById("globalLoading");e<0?n.style.display="none":(n.style.display="flex",n.innerHTML='<div class="spinner"></div><span class="loading-text">'+e+"/"+t+"</span>")}const MAX_ITEMS_PER_FEED=500;let loadingOlder=!1;async function loadNextPage(e){const t=feeds.find(t=>t.url===e);if(!t||!t.nextPageUrl)return;const n=t._visitedPages instanceof Set?t._visitedPages:t._visitedPages=new Set;if(!n.has(t.nextPageUrl)){n.add(t.nextPageUrl);try{const n=parseFeed(await fetchCors(t.nextPageUrl),e),r=new Set(articles.filter(t=>t.feedUrl===e).map(articleKey)),i=n.items.filter(e=>!r.has(articleKey(e)));i.forEach(e=>knownSet.add(articleKey(e))),articles=articles.concat(i),t.nextPageUrl=n.nextPageUrl||null;let s=articles.filter(t=>t.feedUrl===e);if(s.length>500){s.sort((e,t)=>sortT(t.pubDate)-sortT(e.pubDate));const t=new Set(s.slice(500).map(articleKey));articles=articles.filter(n=>n.feedUrl!==e||!t.has(articleKey(n))),s=s.slice(0,500)}await setCache(e,t.title,t.icon,s,t.nextPageUrl),saveKnown(),cFiltered=null,renderArticleList(),renderFeedList()}catch(e){console.error("Failed to load next page:",e)}}}async function handleLoadOlder(){if(loadingOlder||!activeFeedUrl)return;loadingOlder=!0;const e=document.getElementById("loadOlderBtn");e&&(e.disabled=!0,e.textContent="Loading…"),await loadNextPage(activeFeedUrl),loadingOlder=!1}function scheduleAuto(){autoTimer&&clearTimeout(autoTimer),countdownTimer&&clearInterval(countdownTimer),nextRefreshAt=Date.now()+3e5,updCountdown(),countdownTimer=setInterval(updCountdown,3e4),autoTimer=setTimeout(()=>refreshAll(!0).then(autoSync),3e5)}function updCountdown(){const e=document.getElementById("nextRefreshLabel"),t=Math.ceil(Math.max(0,nextRefreshAt-Date.now())/6e4);e.textContent=t<=0?"refreshing…":"refresh in "+t+"m"}function exportOpml(){let e='<?xml version="1.0" encoding="UTF-8"?>\n<opml version="2.0">\n<head><title>Siphon</title></head>\n<body>\n';feeds.forEach(t=>{e+='  <outline type="rss" text="'+escX(t.title)+'" xmlUrl="'+escX(t.url)+'" />\n'}),e+="</body>\n</opml>";const t=document.createElement("a");t.href=URL.createObjectURL(new Blob([e],{type:"application/xml"})),t.download="siphon-feeds.opml",t.click()}async function importOpml(e){const t=e.target.files[0];if(!t)return;const n=await t.text(),r=(new DOMParser).parseFromString(n,"text/xml");let i=0;r.querySelectorAll("outline[xmlUrl]").forEach(e=>{const t=e.getAttribute("xmlUrl"),n=e.getAttribute("text")||e.getAttribute("title")||t;t&&!feeds.find(e=>e.url===t)&&(feeds.push({url:t,title:n,icon:""}),i++)}),saveFeeds(),renderFeedList(),i>0&&(refreshAll(!0),deferSync()),e.target.value=""}const rSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',xSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',dotsSvg='<svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>',starSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',starFillSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',upSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',downSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',markReadSvg='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';function getSortedFeeds(){return feeds.slice().sort((e,t)=>{const n=e.fav?1:0,r=t.fav?1:0;return n!==r?r-n:feeds.indexOf(e)-feeds.indexOf(t)})}function toggleFav(e,t){t&&t.stopPropagation(),openMenuId=null;const n=feeds.find(t=>t.url===e);n&&(n.fav=!n.fav),saveFeeds(),renderFeedList(),deferSync()}function moveFeed(e,t,n){n&&n.stopPropagation(),openMenuId=null;const r=feeds.findIndex(t=>t.url===e);if(r<0)return;const i=r+t;i<0||i>=feeds.length||([feeds[r],feeds[i]]=[feeds[i],feeds[r]],saveFeeds(),renderFeedList(),deferSync())}let dragUrl=null;function onDragStart(e,t){dragUrl=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e),setTimeout(()=>{const t=document.querySelector('[data-feed-url="'+CSS.escape(e)+'"]');t&&t.classList.add("dragging")},0)}function onDragEnd(e){document.querySelectorAll(".feed-item").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")}),dragUrl=null}function onDragOver(e,t){if(t.preventDefault(),t.dataTransfer.dropEffect="move",e===dragUrl)return;const n=t.currentTarget.getBoundingClientRect(),r=n.top+n.height/2;document.querySelectorAll(".feed-item").forEach(e=>{e.classList.remove("drag-over-top","drag-over-bottom")}),t.clientY<r?t.currentTarget.classList.add("drag-over-top"):t.currentTarget.classList.add("drag-over-bottom")}function onDragLeave(e){e.currentTarget.classList.remove("drag-over-top","drag-over-bottom")}function onDrop(e,t){if(t.preventDefault(),document.querySelectorAll(".feed-item").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")}),!dragUrl||dragUrl===e)return;const n=feeds.findIndex(e=>e.url===dragUrl),r=feeds.findIndex(t=>t.url===e);if(n<0||r<0)return;const[i]=feeds.splice(n,1),s=t.currentTarget.getBoundingClientRect(),a=s.top+s.height/2,l=t.clientY<a?feeds.findIndex(t=>t.url===e):feeds.findIndex(t=>t.url===e)+1;feeds.splice(l<0?feeds.length:l,0,i),saveFeeds(),renderFeedList(),deferSync(),dragUrl=null}function renderFeedList(){const e=document.getElementById("feedList");if(!feeds.length)return void(e.innerHTML='<div class="state-message" style="height:auto;padding:30px 16px;"><div class="state-title" style="font-size:16px;">No feeds yet</div><div class="state-desc">Paste a URL above, e.g.<br><code onclick="document.getElementById(\'feedUrl\').value=\'https://hnrss.org/frontpage\';document.getElementById(\'feedUrl\').focus();">hnrss.org/frontpage</code></div></div>');const t=articles.length,n=articles.filter(e=>!isRead(e)).length,r=articles.filter(e=>isNew(e)).length,i=getSortedFeeds();let s='<div class="feed-section-label">Feeds</div>';s+='<div class="feed-item '+(null===activeFeedUrl?"active":"")+'" onclick="selectFeed(null)"><div class="feed-icon-wrap"><div class="feed-icon-circle" style="background:var(--accent);color:var(--bg);font-size:13px;">✦</div></div><div class="feed-info"><div class="feed-name">All Articles</div></div><div class="feed-right">'+(r>0?'<span class="new-badge">'+r+"</span>":"")+'<div class="feed-count">'+n+" / "+t+"</div></div></div>";let a=null;i.forEach((e,t)=>{const n=!!e.fav;null===a&&n&&(s+='<div class="feed-section-label">★ Favorites</div>'),!0!==a||n||(s+='<div class="feed-section-label">All</div>'),a=n;const r=articles.filter(t=>t.feedUrl===e.url),i=r.length,l=r.filter(e=>!isRead(e)).length,o=r.filter(e=>isNew(e)).length,c=esc((e.title||"?")[0].toUpperCase()),d=e.icon?'<img src="'+esc(e.icon)+'" onerror="this.parentElement.textContent=\''+c+"'\">":c,u="menu_"+e.url.replace(/\W/g,"_"),g=esc(e.url),f=feeds.indexOf(e),h='<div class="feed-fav-star'+(n?" is-fav":"")+'">'+starFillSvg+"</div>";s+='<div class="feed-item '+(activeFeedUrl===e.url?"active":"")+'" data-feed-url="'+g+'" draggable="true" onclick="selectFeed(\''+g+"')\" ondragstart=\"onDragStart('"+g+'\',event)" ondragend="onDragEnd(event)" ondragover="onDragOver(\''+g+'\',event)" ondragleave="onDragLeave(event)" ondrop="onDrop(\''+g+'\',event)"><div class="feed-icon-wrap"><div class="feed-icon-circle">'+d+"</div>"+h+'</div><div class="feed-info"><div class="feed-name">'+esc(e.title)+'</div><div class="feed-url-hint">'+esc(hostOf(e.url))+'</div></div><div class="feed-right">'+(o>0?'<span class="new-badge">'+o+"</span>":"")+'<div class="feed-count">'+l+"/"+i+'</div><div class="feed-actions"><button class="feed-dots" onclick="toggleFeedMenu(\''+u+'\',event)" title="More">'+dotsSvg+'</button><div class="feed-menu" id="'+u+'"><button class="feed-menu-item" onclick="toggleFav(\''+g+"',event)\">"+(n?starFillSvg+" Unfavorite":starSvg+" Favorite")+'</button><button class="feed-menu-item" onclick="moveFeed(\''+g+"',-1,event)\""+(0===f?' disabled style="opacity:.3;pointer-events:none"':"")+">"+upSvg+' Move up</button><button class="feed-menu-item" onclick="moveFeed(\''+g+"',1,event)\""+(f===feeds.length-1?' disabled style="opacity:.3;pointer-events:none"':"")+">"+downSvg+' Move down</button><button class="feed-menu-item" onclick="markAllReadFeed(\''+g+"',event)\">"+markReadSvg+' Mark all read</button><button class="feed-menu-item" onclick="refreshSingleFeed(\''+g+"',event)\">"+rSvg+' Refresh</button><button class="feed-menu-item danger" onclick="removeFeed(\''+g+"',event)\">"+xSvg+" Remove</button></div></div></div></div>"}),e.innerHTML=s}let openMenuId=null;function toggleFeedMenu(e,t){if(t.stopPropagation(),openMenuId&&openMenuId!==e){const e=document.getElementById(openMenuId);e&&e.classList.remove("open")}const n=document.getElementById(e);if(!n)return;const r=n.classList.toggle("open");openMenuId=r?e:null}document.addEventListener("click",()=>{if(openMenuId){const e=document.getElementById(openMenuId);e&&e.classList.remove("open"),openMenuId=null}});const RH=95,SH=34,OS=8;let lastRange=null,layout=[];function dateBucket(e){if(!e)return"Older";try{const t=new Date(e);if(isNaN(t))return"Older";const n=new Date,r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),i=new Date(r);i.setDate(r.getDate()-1);const s=new Date(r);s.setDate(r.getDate()-7);const a=new Date(r);return a.setDate(r.getDate()-30),t>=r?"Today":t>=i?"Yesterday":t>=s?"Last 7 Days":t>=a?"Last 30 Days":"Older"}catch{return"Older"}}function buildLayout(e){layout=[];let t=0,n=null;for(let r=0;r<e.length;r++){const i=dateBucket(e[r].pubDate);i!==n&&(layout.push({t:"s",y:t,h:34,l:i}),t+=34,n=i),layout.push({t:"a",y:t,h:RH,i:r}),t+=RH}return t}function renderArticleList(){const e=document.getElementById("articleList"),t=document.getElementById("listTitle"),n=document.getElementById("listCount"),r=getFiltered();document.getElementById("hideReadToggle").classList.toggle("on",hideRead);const i=activeFeedUrl?articles.filter(e=>e.feedUrl===activeFeedUrl):articles;if(document.getElementById("unreadBadge").textContent=i.filter(e=>!isRead(e)).length+" unread / "+i.length,t.textContent=activeFeedUrl?feeds.find(e=>e.url===activeFeedUrl)?.title||"Feed":"All Articles",n.textContent=r.length+" shown",!r.length)return lastRange=null,layout=[],void(e.innerHTML='<div class="state-message"><div class="state-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--text-faint)" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg></div><div class="state-title">'+(hideRead?"All caught up":"No articles")+'</div><div class="state-desc">'+(hideRead?'No unread articles. Toggle "Hide read" to see everything.':"Try refreshing, or the feed may be empty.")+"</div></div>");const s=buildLayout(r),a=activeFeedUrl?feeds.find(e=>e.url===activeFeedUrl):null,l=a&&a.nextPageUrl?'<div style="padding:16px;text-align:center;"><button class="btn btn-small btn-ghost" id="loadOlderBtn" onclick="handleLoadOlder()">Load older articles</button></div>':"";e.innerHTML='<div id="vs" style="height:'+s+'px;position:relative;"></div>'+l,lastRange=null,e.removeEventListener("scroll",onScroll),e.addEventListener("scroll",onScroll),renderVisibleRows()}function onScroll(){renderVisibleRows()}const circSvg='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>',checkSvg='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';function renderVisibleRows(){const e=document.getElementById("articleList"),t=document.getElementById("vs");if(!t||!layout.length)return;const n=getFiltered(),r=e.scrollTop,i=e.clientHeight,s=r-OS*RH,a=r+i+OS*RH;let l=0,o=layout.length,c=0,d=layout.length-1;for(;c<=d;){const e=c+d>>1;layout[e].y+layout[e].h<s?c=e+1:d=e-1}for(l=Math.max(0,c-1),c=l,d=layout.length-1;c<=d;){const e=c+d>>1;layout[e].y>a?d=e-1:c=e+1}o=Math.min(layout.length,c+1);const u=l+":"+o+":"+activeArticleIdx+":"+n.length+":"+readSet.size+":"+newSet.size;if(lastRange===u)return;lastRange=u;let g="";for(let e=l;e<o;e++){const t=layout[e];if("s"===t.t)g+='<div class="date-section" style="top:'+t.y+'px;"><span class="date-section-label">'+t.l+'</span><div class="date-section-line"></div></div>';else{const e=n[t.i],r=isRead(e),i=isNew(e);g+='<div class="'+("article-row"+(r?" is-read":"")+(i?" is-new":"")+(activeArticleIdx===t.i?" active":""))+'" style="position:absolute;top:'+t.y+'px;left:0;right:0;" onclick="openArticle('+t.i+')"><div class="article-row-top"><div class="article-row-title">'+esc(e.title)+"</div>"+(i?'<span class="new-badge">new</span>':"")+'</div><div class="article-row-meta">'+(activeFeedUrl?"":'<span class="source">'+esc(e.feedTitle)+"</span>")+(e.author?"<span>"+esc(e.author)+"</span>":"")+"<span>"+fmtDate(e.pubDate)+'</span></div><div class="article-row-snippet">'+esc(stripHtml(e.description||e.content).slice(0,200))+'</div><button class="row-read-btn" onclick="toggleReadRow('+t.i+',event)" title="'+(r?"Mark unread":"Mark read")+'">'+(r?checkSvg:circSvg)+"</button></div>"}}t.innerHTML=g}function openArticle(e){const t=getFiltered();if(e<0||e>=t.length)return;activeArticleIdx=e;const n=t[e];exemptKey=articleKey(n),markRead(n),newSet.delete(articleKey(n)),cFiltered=null,sessionStorage.setItem("siphon_view",JSON.stringify({feed:activeFeedUrl,article:articleKey(n)})),renderOpenArticle(),lastRange=null,renderVisibleRows(),renderFeedList(),navigate("reader")}function renderOpenArticle(){const e=getFiltered();if(activeArticleIdx<0||activeArticleIdx>=e.length)return;const t=e[activeArticleIdx],n=isRead(t),r=document.getElementById("readerScroll");document.getElementById("readerHeaderLabel").textContent=esc(t.feedTitle),r.innerHTML='<div class="reader-title">'+esc(t.title)+'</div><div class="reader-meta"><span class="source">'+esc(t.feedTitle)+"</span>"+(t.author?"<span>"+esc(t.author)+"</span>":"")+"<span>"+fmtDate(t.pubDate)+'</span><button class="reader-read-toggle" onclick="toggleReadInReader()">'+(n?"✓ Read — mark unread":"○ Unread — mark read")+"</button></div>"+(t.link?'<a class="reader-link" href="'+esc(t.link)+'" target="_blank" rel="noopener noreferrer">Open original ↗</a>':"")+'<div class="reader-content">'+sanitize(t.content||t.description)+'</div><div class="reader-nav">'+(activeArticleIdx>0?'<button class="btn btn-small btn-ghost" onclick="openArticle('+(activeArticleIdx-1)+')">← Previous</button>':"")+(activeArticleIdx<e.length-1?'<button class="btn btn-small btn-ghost" onclick="openArticle('+(activeArticleIdx+1)+')">Next →</button>':"")+"</div>",r.scrollTop=0}async function hashPhrase(e){const t=new TextEncoder,n=await crypto.subtle.importKey("raw",t.encode(e),"PBKDF2",!1,["deriveBits"]),r=await crypto.subtle.deriveBits({name:"PBKDF2",salt:t.encode("siphon-feed-reader-sync-v2"),iterations:6e5,hash:"SHA-256"},n,256);return[...new Uint8Array(r)].map(e=>e.toString(16).padStart(2,"0")).join("")}function getSyncPhrase(){return(sessionStorage.getItem("siphon_sync_phrase")||"").trim()}function saveSyncPhrase(e){sessionStorage.setItem("siphon_sync_phrase",e.trim())}function syncStatusMsg(e){const t=document.getElementById("syncStatus");t&&(t.textContent=e)}async function syncPull(e){const t=await fetch("/sync?key="+e);if(404===t.status)return null;if(!t.ok)throw new Error("Sync fetch failed");return t.json()}async function syncPush(e,t){if(!(await fetch("/sync?key="+e,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw new Error("Sync push failed")}function mergeSyncData(e,t){const n=new Map(e.feeds.map(e=>[e.url,e]));(t.feeds||[]).forEach(e=>{n.has(e.url)||n.set(e.url,e)});const r=[...n.values()],i=[...new Set([...t.read||[],...e.read])];i.length>5e3&&i.splice(0,i.length-5e3);const s=[...new Set([...t.known||[],...e.known])];s.length>1e4&&s.splice(0,s.length-1e4);return{feeds:r,read:i,known:s,hideRead:(t.ts||0)>(e.ts||0)?!!t.hideRead:e.hideRead,ts:Date.now()}}async function syncNow(){const e=document.getElementById("syncPhrase").value.trim();if(e){saveSyncPhrase(e),syncStatusMsg("Syncing…");try{const t=await hashPhrase(e),n={feeds:feeds,read:[...readSet],known:[...knownSet],hideRead:hideRead,ts:Date.now()},r=await syncPull(t),i=r?mergeSyncData(n,r):n;feeds=i.feeds,readSet=new Set(i.read),knownSet=new Set(i.known),hideRead=i.hideRead,saveFeeds(),saveRead(),saveKnown(),localStorage.setItem("siphon_hideread",JSON.stringify(hideRead)),document.getElementById("hideReadToggle").classList.toggle("on",hideRead),cFiltered=null,renderFeedList(),renderArticleList(),await syncPush(t,i),saveTs(),syncStatusMsg("Synced "+(new Date).toLocaleTimeString())}catch(e){syncStatusMsg("Sync error: "+e.message)}}else syncStatusMsg("Enter a passphrase.")}let deferSyncTimer=null;function deferSync(){getSyncPhrase()&&(deferSyncTimer&&clearTimeout(deferSyncTimer),deferSyncTimer=setTimeout(()=>{deferSyncTimer=null,autoSync()},3e3))}async function autoSync(){const e=getSyncPhrase();if(e)try{const t=await hashPhrase(e),n={feeds:feeds,read:[...readSet],known:[...knownSet],hideRead:hideRead,ts:Date.now()},r=await syncPull(t),i=r?mergeSyncData(n,r):n;feeds=i.feeds,readSet=new Set(i.read),knownSet=new Set(i.known),hideRead=i.hideRead,saveFeeds(),saveRead(),saveKnown(),localStorage.setItem("siphon_hideread",JSON.stringify(hideRead)),document.getElementById("hideReadToggle").classList.toggle("on",hideRead),cFiltered=null,renderFeedList(),renderArticleList(),await syncPush(t,i),saveTs(),syncStatusMsg("Synced "+(new Date).toLocaleTimeString())}catch(e){syncStatusMsg("Auto-sync error: "+(e.message||"unknown"))}}async function initSync(){const e=getSyncPhrase();if(e)try{syncStatusMsg("Syncing…");const t=await hashPhrase(e),n=await syncPull(t);if(n&&(n.ts||0)>localTs){const e=mergeSyncData({feeds:feeds,read:[...readSet],known:[...knownSet],hideRead:hideRead,ts:localTs},n);feeds=e.feeds,readSet=new Set(e.read),knownSet=new Set(e.known),hideRead=e.hideRead,saveFeeds(),saveRead(),saveKnown(),localStorage.setItem("siphon_hideread",JSON.stringify(hideRead)),document.getElementById("hideReadToggle").classList.toggle("on",hideRead),await loadFromCache(),cFiltered=null,renderFeedList(),renderArticleList()}const r={feeds:feeds,read:[...readSet],known:[...knownSet],hideRead:hideRead,ts:Date.now()};await syncPush(t,r),saveTs(),syncStatusMsg("Synced "+(new Date).toLocaleTimeString())}catch(e){syncStatusMsg("Sync error: "+(e.message||"unknown"))}await refreshStale()}window.addEventListener("resize",()=>navigate(currentView)),document.getElementById("hideReadToggle").classList.toggle("on",hideRead),document.getElementById("syncPhrase").value=getSyncPhrase(),getSyncPhrase()&&syncStatusMsg("Passphrase saved. Will sync on refresh."),renderFeedList(),(async()=>{try{await openCacheDB(),await migrateCache()}catch{}if(feeds.length>0){let e=null;try{e=JSON.parse(sessionStorage.getItem("siphon_view"))}catch{}if(activeFeedUrl=e?.feed??null,activeArticleIdx=-1,await loadFromCache(),cFiltered=null,e?.article){const t=getFiltered().findIndex(t=>articleKey(t)===e.article);t>=0?openArticle(t):(renderFeedList(),renderArticleList(),navigate("list"))}else renderFeedList(),renderArticleList(),navigate("list");initSync()}else navigate("feeds"),initSync()})(),history.replaceState({view:"feeds"},""),"feeds"!==currentView&&history.pushState({view:currentView},""),_navPush=!0,window.addEventListener("popstate",e=>{_navPush=!1;const t=e.state?.view||"feeds";"reader"===t&&activeArticleIdx>=0?navigate("reader"):"list"===t?showList():showFeeds(),_navPush=!0})</script></body></html>